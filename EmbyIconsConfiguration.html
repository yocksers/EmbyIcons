<div is="emby-scroller" class="view flex flex-direction-column scrollFrameY flex-grow" data-horizontal="false" data-forcescrollbar="true" data-centerfocus="true" data-bindheader="true" data-controller="__plugin/EmbyIconsConfigurationjs" data-title="EmbyIcons">

    <div class="scrollSlider flex-grow flex-direction-column padded-left padded-left-page padded-right padded-top-page padded-bottom-page">
        <div class="readOnlyContent auto-center">

            <div data-role="controlgroup" data-type="horizontal" class="localnav">
                <a is="emby-linkbutton" class="nav-button ui-btn-active" href="#" data-role="button" data-target="settingsPage">Settings</a>
                <a is="emby-linkbutton" class="nav-button" href="#" data-role="button" data-target="iconManagerPage">Icon Manager</a>
                <a is="emby-linkbutton" class="nav-button" href="#" data-role="button" data-target="troubleshooterPage">Troubleshooter</a>
                <a is="emby-linkbutton" class="nav-button" href="#" data-role="button" data-target="readmePage">Readme</a>
            </div>

            <div id="settingsPage" style="margin-top: 2em;">
                <form class="embyIconsForm">
                    <!-- Global Settings -->
                    <div class="flex align-items-center" style="margin: 2em 0 .5em;">
                        <h2 style="margin: 0;">Global Settings</h2>
                    </div>
                    <p class="fieldDescription" style="margin-bottom: 1.5em;">These settings apply to all profiles and libraries.</p>

                    <div class="paper-card" style="padding: 1.5em;">
                        <div class="inputContainer">
                            <select is="emby-select" id="selIconLoadingMode" label="Icon Loading Mode:" data-config-key="IconLoadingMode">
                                <option value="Hybrid">Custom with Built-in Fallback (Recommended)</option>
                                <option value="CustomOnly">Custom Icons Only</option>
                                <option value="BuiltInOnly">Built-in Icons Only</option>
                            </select>
                            <div class="fieldDescription">"Fallback" will use bundled icons if a custom one isn't found. This provides a great default experience.</div>
                        </div>
                        <div class="inputContainer" style="margin-top: 1.5em;">
                            <div style="display: flex; align-items: flex-end;">
                                <div class="emby-input-with-icon" style="flex-grow: 1;">
                                    <input is="emby-input" type="text" id="txtIconsFolder" label="Custom Icons Folder:" autocomplete="off" data-config-key="IconsFolder" />
                                    <i id="folderWarningIcon" class="input-icon md-icon" style="color: #ffc107; display: none;" title="The specified folder does not exist on the server.">warning</i>
                                </div>
                                <button type="button" is="emby-button" class="raised" id="btnSelectIconsFolder" title="Browse for folder" style="margin-left: 1em;">
                                    <span>...</span>
                                </button>
                            </div>
                            <div id="iconsFolderWarning" class="fieldDescription" style="color: #ffc107; display: none; margin-top: .5em;"></div>
                            <div class="fieldDescription">Full path to your custom icons. Ignored if mode is “Built-in Icons Only”.</div>
                        </div>

                        <div class="inputContainer" style="margin-top: 1.5em;">
                            <select is="emby-select" id="selOutputFormat" label="Image Output Format:" data-config-key="OutputFormat">
                                <option value="Auto">Auto (Recommended, preserves transparency)</option>
                                <option value="Jpeg">JPEG (Smaller files, no transparency)</option>
                                <option value="Png">PNG (Highest quality, large files)</option>
                            </select>
                            <div class="fieldDescription">"Auto" will output PNGs if the original poster is a PNG, otherwise it will use JPEG.</div>
                        </div>

                        <div class="inputContainer" style="margin-top: 1.5em;">
                            <input is="emby-input" type="number" label="Image Quality (10-100):" min="10" max="100" data-config-key="JpegQuality" />
                            <div class="fieldDescription">Used for JPEG output format. Higher is better.</div>
                        </div>
                        <div class="checkboxContainer" style="margin-top: 1.5em;">
                            <label>
                                <input is="emby-checkbox" type="checkbox" data-config-key="EnableImageSmoothing" />
                                <span>Enable image smoothing (improves icon quality on scaled images)</span>
                            </label>
                        </div>
                        <div class="checkboxContainer" style="margin-top: 1.5em;">
                            <label>
                                <input is="emby-checkbox" type="checkbox" data-config-key="EnableCollectionProfileLookup" />
                                <span>Enable deep profile lookup for collections</span>
                            </label>
                            <div class="fieldDescription">Required for icons on collections, but may cause slowdowns on the home screen for some users. If you experience UI lag, try disabling this.</div>
                        </div>
                        <div class="checkboxContainer" style="margin-top: 1.5em;">
                            <label>
                                <input is="emby-checkbox" type="checkbox" id="chkEnableDebugLogging" data-config-key="EnableDebugLogging" />
                                <span>Enable detailed debug logging</span>
                            </label>
                            <div class="fieldDescription">Logs additional information to the Emby server log (useful for troubleshooting).</div>
                        </div>
                    </div>

                    <!-- Profiles Section -->
                    <div class="flex align-items-center" style="margin: 3em 0 .5em;">
                        <h2 style="margin: 0;">Icon Profiles</h2>
                    </div>
                    <p class="fieldDescription" style="margin-bottom: 1.5em;">Create different sets of icon rules and assign them to specific libraries. All settings below this point are specific to the profile being edited.</p>

                    <div class="paper-card" style="padding: 1.5em;">
                        <div class="inputContainer">
                            <label for="selActiveProfile" class="inputLabel">Editing Profile:</label>
                            <div style="display: flex; gap: 1em;">
                                <select is="emby-select" id="selActiveProfile" style="flex-grow: 1;"></select>
                                <button is="emby-button" type="button" class="raised button-submit" id="btnAddProfile" title="Add New Profile"><span>+</span></button>
                                <button is="emby-button" type="button" class="raised" id="btnRenameProfile" title="Rename Profile"><span>Rename</span></button>
                                <button is="emby-button" type="button" class="raised button-cancel" id="btnDeleteProfile" title="Delete Profile"><span></span></button>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Settings Container -->
                    <div id="profileSettingsContainer">
                        <div class="inputContainer" style="margin-top: 2.5em;">
                            <h3 style="margin-bottom: 0.5em;">Assign this profile to libraries</h3>
                            <p class="fieldDescription" style="margin-top:0;">A library can only be assigned to one profile at a time.</p>
                            <div id="librarySelectionContainer" class="paper-card" style="padding: 1em 1.5em; display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1em 1.5em;">
                            </div>
                        </div>

                        <!-- Image Type Settings -->
                        <div class="flex align-items-center" style="margin: 3em 0 .5em;">
                            <h2 style="margin: 0;">Image Type Settings</h2>
                        </div>
                        <div class="paper-card" style="padding: 1.5em;">
                            <p class="fieldDescription" style="margin-top:0; margin-bottom: 1.5em;">Select which image types should have icons overlaid. “Primary” refers to the main poster image.</p>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label><input is="emby-checkbox" type="checkbox" data-profile-key="EnableForPosters" /><span>Enable overlays on Posters (Primary)</span></label>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label><input is="emby-checkbox" type="checkbox" data-profile-key="EnableForThumbs" /><span>Enable overlays on Thumbs</span></label>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label><input is="emby-checkbox" type="checkbox" data-profile-key="EnableForBanners" /><span>Enable overlays on Banners</span></label>
                            </div>
                        </div>

                        <div class="flex align-items-center" style="margin: 3em 0 .5em;">
                            <h2 style="margin: 0;">TV Show Settings</h2>
                        </div>
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label><input is="emby-checkbox" type="checkbox" data-profile-key="ShowOverlaysForEpisodes" /><span>Show overlays on episode images</span></label>
                            <div class="fieldDescription checkboxFieldDescription">When disabled, overlays only appear on movies and TV shows.</div>
                        </div>
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label><input is="emby-checkbox" type="checkbox" data-profile-key="ShowOverlaysForSeasons" /><span>Show overlays on season images</span></label>
                            <div class="fieldDescription checkboxFieldDescription">When enabled, icons will also appear on season posters based on the episodes within that season.</div>
                        </div>
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label><input is="emby-checkbox" type="checkbox" data-profile-key="ShowSeriesIconsIfAllEpisodesHaveLanguage" /><span>Show icons on TV show posters</span></label>
                            <div class="fieldDescription checkboxFieldDescription">Language icons require all child episodes share the same language (matched by the display language name).</div>
                        </div>
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label><input is="emby-checkbox" type="checkbox" data-profile-key="ExcludeSpecialsFromSeriesAggregation" /><span>Exclude 'Specials' season from series icon calculations</span></label>
                            <div class="fieldDescription checkboxFieldDescription">When enabled, episodes in the 'Specials' season won't affect the icons shown on the main series poster.</div>
                        </div>
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label><input is="emby-checkbox" type="checkbox" data-profile-key="UseSeriesLiteMode" /><span>Use Lite Mode for TV show scans</span></label>
                            <div class="fieldDescription checkboxFieldDescription">Faster, but less accurate. Only checks the first episode to determine icons for the entire series.</div>
                        </div>

                        <div class="flex align-items-center" style="margin: 3em 0 .5em;">
                            <h2 style="margin: 0;">Collection Settings</h2>
                        </div>
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label><input is="emby-checkbox" type="checkbox" data-profile-key="ShowCollectionIconsIfAllChildrenHaveLanguage" /><span>Show icons on collections</span></label>
                            <div class="fieldDescription checkboxFieldDescription">Language icons appear only if all child items share the same display language. Other icons appear when common to all children.</div>
                        </div>
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label><input is="emby-checkbox" type="checkbox" data-profile-key="UseCollectionLiteMode" /><span>Use Lite Mode for collection scans</span></label>
                            <div class="fieldDescription checkboxFieldDescription">Faster, but less accurate. Only checks the first item to determine icons for the entire collection.</div>
                        </div>

                        <div class="flex align-items-center" style="margin: 3em 0 .5em;">
                            <h2 style="margin: 0;">Alignment & Layout</h2>
                        </div>
                        <div class="paper-card" style="padding: 1.5em;">
                            <div class="alignment-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2em 2.5em;">
                                <div>
                                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 0 1em;">
                                        <select is="emby-select" label="Audio Language Icons" data-profile-key="AudioIconAlignment" data-corner-group="TopLeft"><option value="Disabled">Disabled</option><option value="TopLeft">Top Left</option><option value="TopRight">Top Right</option><option value="BottomLeft">Bottom Left</option><option value="BottomRight">Bottom Right</option></select>
                                        <select is="emby-select" label="Priority" data-profile-key="AudioIconPriority" data-corner-group="TopLeft"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option></select>
                                    </div>
                                    <div class="checkboxContainer" style="margin-top: 1.5em;"><label><input is="emby-checkbox" type="checkbox" data-profile-key="AudioOverlayHorizontal" /><span>Layout Horizontally</span></label></div>
                                </div>
                                <div>
                                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 0 1em;">
                                        <select is="emby-select" label="Subtitle Language Icons" data-profile-key="SubtitleIconAlignment" data-corner-group="BottomLeft"><option value="Disabled">Disabled</option><option value="TopLeft">Top Left</option><option value="TopRight">Top Right</option><option value="BottomLeft">Bottom Left</option><option value="BottomRight">Bottom Right</option></select>
                                        <select is="emby-select" label="Priority" data-profile-key="SubtitleIconPriority" data-corner-group="BottomLeft"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option></select>
                                    </div>
                                    <div class="checkboxContainer" style="margin-top: 1.5em;"><label><input is="emby-checkbox" type="checkbox" data-profile-key="SubtitleOverlayHorizontal" /><span>Layout Horizontally</span></label></div>
                                </div>
                                <div>
                                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 0 1em;">
                                        <select is="emby-select" label="Audio Channel Icons (e.g., 7.1)" data-profile-key="ChannelIconAlignment" data-corner-group="TopLeft"><option value="Disabled">Disabled</option><option value="TopLeft">Top Left</option><option value="TopRight">Top Right</option><option value="BottomLeft">Bottom Left</option><option value="BottomRight">Bottom Right</option></select>
                                        <select is="emby-select" label="Priority" data-profile-key="ChannelIconPriority" data-corner-group="TopLeft"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option></select>
                                    </div>
                                    <div class="checkboxContainer" style="margin-top: 1.5em;"><label><input is="emby-checkbox" type="checkbox" data-profile-key="ChannelOverlayHorizontal" /><span>Layout Horizontally</span></label></div>
                                </div>
                                <div>
                                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 0 1em;">
                                        <select is="emby-select" label="Audio Codec Icons (e.g., DTS)" data-profile-key="AudioCodecIconAlignment" data-corner-group="TopLeft"><option value="Disabled">Disabled</option><option value="TopLeft">Top Left</option><option value="TopRight">Top Right</option><option value="BottomLeft">Bottom Left</option><option value="BottomRight">Bottom Right</option></select>
                                        <select is="emby-select" label="Priority" data-profile-key="AudioCodecIconPriority" data-corner-group="TopLeft"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option></select>
                                    </div>
                                    <div class="checkboxContainer" style="margin-top: 1.5em;"><label><input is="emby-checkbox" type="checkbox" data-profile-key="AudioCodecOverlayHorizontal" /><span>Layout Horizontally</span></label></div>
                                </div>
                                <div>
                                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 0 1em;">
                                        <select is="emby-select" label="Video Format Icons (e.g., HDR)" data-profile-key="VideoFormatIconAlignment" data-corner-group="TopRight"><option value="Disabled">Disabled</option><option value="TopLeft">Top Left</option><option value="TopRight">Top Right</option><option value="BottomLeft">Bottom Left</option><option value="BottomRight">Bottom Right</option></select>
                                        <select is="emby-select" label="Priority" data-profile-key="VideoFormatIconPriority" data-corner-group="TopRight"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option></select>
                                    </div>
                                    <div class="checkboxContainer" style="margin-top: 1.5em;"><label><input is="emby-checkbox" type="checkbox" data-profile-key="VideoFormatOverlayHorizontal" /><span>Layout Horizontally</span></label></div>
                                </div>
                                <div>
                                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 0 1em;">
                                        <select is="emby-select" label="Video Codec Icons (e.g., H265)" data-profile-key="VideoCodecIconAlignment" data-corner-group="TopRight"><option value="Disabled">Disabled</option><option value="TopLeft">Top Left</option><option value="TopRight">Top Right</option><option value="BottomLeft">Bottom Left</option><option value="BottomRight">Bottom Right</option></select>
                                        <select is="emby-select" label="Priority" data-profile-key="VideoCodecIconPriority" data-corner-group="TopRight"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option></select>
                                    </div>
                                    <div class="checkboxContainer" style="margin-top: 1.5em;"><label><input is="emby-checkbox" type="checkbox" data-profile-key="VideoCodecOverlayHorizontal" /><span>Layout Horizontally</span></label></div>
                                </div>
                                <div>
                                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 0 1em;">
                                        <select is="emby-select" label="Custom Tag Icons" data-profile-key="TagIconAlignment" data-corner-group="BottomLeft"><option value="Disabled">Disabled</option><option value="TopLeft">Top Left</option><option value="TopRight">Top Right</option><option value="BottomLeft">Bottom Left</option><option value="BottomRight">Bottom Right</option></select>
                                        <select is="emby-select" label="Priority" data-profile-key="TagIconPriority" data-corner-group="BottomLeft"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option></select>
                                    </div>
                                    <div class="checkboxContainer" style="margin-top: 1.5em;"><label><input is="emby-checkbox" type="checkbox" data-profile-key="TagOverlayHorizontal" /><span>Layout Horizontally</span></label></div>
                                </div>
                                <div>
                                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 0 1em;">
                                        <select is="emby-select" label="Resolution Icons (e.g., 4K)" data-profile-key="ResolutionIconAlignment" data-corner-group="BottomRight"><option value="Disabled">Disabled</option><option value="TopLeft">Top Left</option><option value="TopRight">Top Right</option><option value="BottomLeft">Bottom Left</option><option value="BottomRight">Bottom Right</option></select>
                                        <select is="emby-select" label="Priority" data-profile-key="ResolutionIconPriority" data-corner-group="BottomRight"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option></select>
                                    </div>
                                    <div class="checkboxContainer" style="margin-top: 1.5em;"><label><input is="emby-checkbox" type="checkbox" data-profile-key="ResolutionOverlayHorizontal" /><span>Layout Horizontally</span></label></div>
                                </div>
                                <div>
                                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 0 1em;">
                                        <select is="emby-select" label="Aspect Ratio Icons (e.g., 16:9)" data-profile-key="AspectRatioIconAlignment" data-corner-group="BottomRight"><option value="Disabled">Disabled</option><option value="TopLeft">Top Left</option><option value="TopRight">Top Right</option><option value="BottomLeft">Bottom Left</option><option value="BottomRight">Bottom Right</option></select>
                                        <select is="emby-select" label="Priority" data-profile-key="AspectRatioIconPriority" data-corner-group="BottomRight"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option></select>
                                    </div>
                                    <div class="checkboxContainer" style="margin-top: 1.5em;"><label><input is="emby-checkbox" type="checkbox" data-profile-key="AspectRatioOverlayHorizontal" /><span>Layout Horizontally</span></label></div>
                                    <div class="checkboxContainer checkboxContainer-withDescription" style="margin-top: 1em;">
                                        <label>
                                            <input is="emby-checkbox" type="checkbox" data-profile-key="SnapAspectRatioToCommon" />
                                            <span>Snap to nearest common ratio</span>
                                        </label>
                                        <div class="fieldDescription checkboxFieldDescription">When enabled, snaps calculated ratios to the closest common standard (e.g. 16:9, 2.39:1). When disabled, it uses the precise ratio from the file's metadata.</div>
                                    </div>
                                </div>
                                <div>
                                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 0 1em;">
                                        <select is="emby-select" label="Community Rating Icon" data-profile-key="CommunityScoreIconAlignment" data-corner-group="TopRight"><option value="Disabled">Disabled</option><option value="TopLeft">Top Left</option><option value="TopRight">Top Right</option><option value="BottomLeft">Bottom Left</option><option value="BottomRight">Bottom Right</option></select>
                                        <select is="emby-select" label="Priority" data-profile-key="CommunityScoreIconPriority" data-corner-group="TopRight"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option></select>
                                    </div>
                                    <div class="checkboxContainer" style="margin-top: 1.5em;"><label><input is="emby-checkbox" type="checkbox" data-profile-key="CommunityScoreOverlayHorizontal" /><span>Layout Horizontally</span></label></div>
                                </div>
                                <div>
                                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 0 1em;">
                                        <select is="emby-select" label="Parental Rating Icons" data-profile-key="ParentalRatingIconAlignment" data-corner-group="TopRight"><option value="Disabled">Disabled</option><option value="TopLeft">Top Left</option><option value="TopRight">Top Right</option><option value="BottomLeft">Bottom Left</option><option value="BottomRight">Bottom Right</option></select>
                                        <select is="emby-select" label="Priority" data-profile-key="ParentalRatingIconPriority" data-corner-group="TopRight"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option></select>
                                    </div>
                                    <div class="checkboxContainer" style="margin-top: 1.5em;"><label><input is="emby-checkbox" type="checkbox" data-profile-key="ParentalRatingOverlayHorizontal" /><span>Layout Horizontally</span></label></div>
                                </div>
                                <div>
                                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 0 1em;">
                                        <select is="emby-select" label="Source Icons (from filename)" data-profile-key="SourceIconAlignment" data-corner-group="BottomRight"><option value="Disabled">Disabled</option><option value="TopLeft">Top Left</option><option value="TopRight">Top Right</option><option value="BottomLeft">Bottom Left</option><option value="BottomRight">Bottom Right</option></select>
                                        <select is="emby-select" label="Priority" data-profile-key="SourceIconPriority" data-corner-group="BottomRight"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option></select>
                                    </div>
                                    <div class="checkboxContainer" style="margin-top: 1.5em;"><label><input is="emby-checkbox" type="checkbox" data-profile-key="SourceOverlayHorizontal" /><span>Layout Horizontally</span></label></div>
                                </div>
                                <div id="ratingAppearanceControls">
                                    <select is="emby-select" label="Rating Background Shape" data-profile-key="CommunityScoreBackgroundShape">
                                        <option value="None">None</option>
                                        <option value="Circle">Circle</option>
                                        <option value="Square">Square</option>
                                    </select>
                                    <div style="margin-top: 1.5em;">
                                        <label class="inputLabel" for="txtCommunityScoreBackgroundColor">Background Color</label>
                                        <input type="color" data-profile-key="CommunityScoreBackgroundColor" style="width: 100%; height: 2.5em; padding: 0.2em; background: transparent; border: 1px solid rgb(85, 85, 85); border-radius: 4px; box-sizing: border-box;">
                                    </div>
                                    <div style="margin-top: 1.5em;">
                                        <label class="inputLabel" for="rngCommunityScoreBackgroundOpacity">Background Opacity: <span class="valCommunityScoreBackgroundOpacity"></span></label>
                                        <input type="range" min="0" max="100" step="1" data-profile-key="CommunityScoreBackgroundOpacity" class="slider" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 3em; margin-bottom: 2em;">
                            <img class="previewImage" alt="Loading Preview..." style="max-height: 24em; display: block; background-color: #101010; margin: auto;" />
                        </div>

                        <div class="flex align-items-center" style="margin: 3em 0 .5em;">
                            <h2 style="margin: 0;">Filename-based Icons</h2>
                        </div>
                        <p class="fieldDescription" style="margin-top:0; margin-bottom: 1.5em;">
                            Display icons for movies based on keywords in the filename (e.g., 'remux', 'extended', 'web-dl'). The icon name you provide is used to find a file like <code>source.icon-name.png</code> in your custom icons folder.
                        </p>
                        <div class="paper-card" style="padding: 1.5em;">
                            <div id="filenameMappingsContainer">
                                <!-- Mappings will be added here by JS -->
                            </div>
                            <button is="emby-button" type="button" class="raised" id="btnAddFilenameMapping" style="margin-top: 1em;">
                                <span>Add Mapping</span>
                            </button>
                        </div>

                        <div class="flex align-items-center" style="margin: 3em 0 .5em;">
                            <h2 style="margin: 0;">Advanced Profile Settings</h2>
                        </div>
                        <div class="paper-card" style="padding: 1.5em;">
                            <div class="inputContainer">
                                <input is="emby-input" type="number" label="Icon Size (% of poster height):" min="1" max="100" data-profile-key="IconSize" />
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 2em;">
                        <button is="emby-button" type="submit" class="raised button-submit block">
                            <span>Save</span>
                        </button>
                    </div>
                </form>
            </div>

            <div id="iconManagerPage" class="hide" style="margin-top: 2em;">
                <div style="max-width: 900px; margin: auto;">
                    <h1 style="margin-bottom: 0.5em;">Icon Manager</h1>
                    <p class="fieldDescription">Scan your media library and custom icon folder to find missing or unused icons. On very large libraries this can take several minutes; results are cached until server restart or configuration changes.</p>
                    <div style="margin-top: 1.5em;">
                        <button is="emby-button" type="button" class="raised button-submit" id="btnRunIconScan">
                            <span>Scan Library & Icons</span>
                        </button>
                    </div>
                    <div id="iconManagerReportContainer" style="margin-top: 2em;">
                        <!-- Report will be injected here by JavaScript -->
                    </div>
                </div>
            </div>

            <div id="troubleshooterPage" class="hide" style="margin-top: 2em;">
                <div style="max-width: 900px; margin: auto;">

                    <!-- Memory Usage -->
                    <h1 style="margin-bottom: 0.5em;">Diagnostics & Maintenance</h1>
                    <div class="paper-card" style="padding: 1.5em;">
                        <h3 style="margin-top:0;">Cache Management</h3>
                        <p class="fieldDescription" style="margin-top:0;">
                            If you add, remove, or change any icon files, clear the cache to apply the changes. Posters will refresh as you browse. This also clears all internal data caches.
                        </p>
                        <div style="margin-top: 1.5em;">
                            <button is="emby-button" type="button" class="raised button-cancel" id="btnClearCache">
                                <span>Clear All Caches</span>
                            </button>
                        </div>
                        <div style="margin-top: 1.5em;">
                            <h4 style="margin-top:1em;">Plugin Memory Usage</h4>
                            <div id="memoryUsageReport" style="font-family: monospace; margin-top: .5em;">Loading...</div>
                            <div style="margin-top: .75em; display:flex; gap: .5em;"><button is="emby-button" type="button" class="raised" id="btnRefreshMemoryUsage"><span>Refresh</span></button></div>
                        </div>
                    </div>


                    <h1 style="margin-top: 2.5em; margin-bottom: 0.5em;">Series Troubleshooter</h1>
                    <p class="fieldDescription">
                        Many icons (e.g., audio language, resolution) appear on a TV show poster only if all episodes share the same property. This tool scans a series and reports inconsistencies.
                    </p>

                    <div class="paper-card" style="padding: 1.5em; margin-top: 2em;">
                        <h3 style="margin-top:0;">Checks to Perform</h3>
                        <p class="fieldDescription" style="margin-top:0;">Uncheck properties you don’t care about to speed up scans and reduce report noise.</p>
                        <div id="troubleshooterChecksContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1em; margin-top: 1.5em;">
                            <div class="checkboxContainer"><label><input is="emby-checkbox" type="checkbox" data-check-name="AudioLanguage" checked /><span>Audio Language</span></label></div>
                            <div class="checkboxContainer"><label><input is="emby-checkbox" type="checkbox" data-check-name="Subtitles" checked /><span>Subtitles</span></label></div>
                            <div class="checkboxContainer"><label><input is="emby-checkbox" type="checkbox" data-check-name="AudioCodec" checked /><span>Audio Codec</span></label></div>
                            <div class="checkboxContainer"><label><input is="emby-checkbox" type="checkbox" data-check-name="VideoCodec" checked /><span>Video Codec</span></label></div>
                            <div class="checkboxContainer"><label><input is="emby-checkbox" type="checkbox" data-check-name="AudioChannels" checked /><span>Audio Channels</span></label></div>
                            <div class="checkboxContainer"><label><input is="emby-checkbox" type="checkbox" data-check-name="Resolution" checked /><span>Resolution</span></label></div>
                            <div class="checkboxContainer"><label><input is="emby-checkbox" type="checkbox" data-check-name="AspectRatio" checked /><span>Aspect Ratio</span></label></div>
                            <div class="checkboxContainer"><label><input is="emby-checkbox" type="checkbox" data-check-name="VideoFormat" checked /><span>Video Format (HDR)</span></label></div>
                        </div>
                    </div>

                    <div class="paper-card" style="padding: 1.5em; margin-top: 2em; position: relative;">
                        <h3 style="margin-top:0;">Scan a Specific TV Show</h3>
                        <div class="inputContainer">
                            <input is="emby-input" type="text" id="txtSeriesSearch" label="Search for a TV Show:" autocomplete="off" />
                            <div id="seriesSearchResults" class="raised paper-card" style="position: absolute; width: calc(100% - 3em); z-index: 10; max-height: 250px; overflow-y: auto; display: none;"></div>
                        </div>
                        <div style="margin-top: 1.5em;">
                            <button is="emby-button" type="button" class="raised button-submit" id="btnRunSeriesScan">
                                <span>Scan Selected Show</span>
                            </button>
                        </div>
                    </div>

                    <div class="paper-card" style="padding: 1.5em; margin-top: 2em;">
                        <h3 style="margin-top:0;">Scan All TV Shows</h3>
                        <p class="fieldDescription" style="margin-top:0;">
                            Scan your entire library to find all TV shows with inconsistencies. This may take several minutes on a large library.
                        </p>
                        <div style="margin-top: 1.5em;">
                            <button is="emby-button" type="button" class="raised" id="btnRunFullSeriesScan">
                                <span>Scan All TV Shows for Inconsistencies</span>
                            </button>
                        </div>
                    </div>

                    <div id="seriesReportContainer" style="margin-top: 2em;">
                        <!-- Report will be injected here by JavaScript -->
                    </div>

                    <h1 style="margin-top: 2.5em; margin-bottom: 0.5em;">Aspect Ratio Calculator</h1>
                    <p class="fieldDescription">
                        Enter your video's resolution to find the correct icon name for its aspect ratio.
                    </p>
                    <div class="paper-card" style="padding: 1.5em; margin-top: 2em;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1.5em; align-items: flex-end;">
                            <div class="inputContainer" style="margin: 0;">
                                <input is="emby-input" type="number" id="txtAspectRatioWidth" label="Video Width (pixels):" min="1" />
                            </div>
                            <div class="inputContainer" style="margin: 0;">
                                <input is="emby-input" type="number" id="txtAspectRatioHeight" label="Video Height (pixels):" min="1" />
                            </div>
                            <button is="emby-button" type="button" class="raised button-submit" id="btnCalculateAspectRatio" style="margin-bottom: 0.5em;">
                                <span>Calculate</span>
                            </button>
                        </div>
                        <div id="aspectRatioResultContainer" style="margin-top: 2em; display: none;">
                            <h3 style="margin-top:0;">Results</h3>
                            <p class="fieldDescription">
                                <strong>Decimal Ratio:</strong> <span id="aspectDecimalValue"></span>
                            </p>
                            <div style="background-color: rgba(128,128,128,0.1); padding: 0.5em 1em; border-radius: 4px; margin-top: 1em;">
                                <p class="fieldDescription" style="margin-bottom: 0.5em;">
                                    For 'Snap to nearest' enabled:
                                </p>
                                <code>ar.<span id="aspectSnappedIconName"></span>.png</code>
                            </div>
                            <div style="background-color: rgba(128,128,128,0.1); padding: 0.5em 1em; border-radius: 4px; margin-top: 1em;">
                                <p class="fieldDescription" style="margin-bottom: 0.5em;">
                                    For precise matching ('Snap to nearest' disabled):
                                </p>
                                <code>ar.<span id="aspectPreciseIconName"></span>.png</code>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="readmePage" class="hide" style="margin-top: 2em;">
                <div style="max-width: 800px; margin: auto;">
                    <h1 style="margin-bottom: 1em;">EmbyIcons Plugin Guide</h1>

                    <h3>Introduction</h3>
                    <p>This plugin overlays icons for language, audio channels, video format, resolution, aspect ratio, parental rating, and community ratings onto your media posters. Provide your own icon images in a designated folder and name them according to the conventions below.</p>
                    <p>Supported image formats for icons are <code>.png</code>, <code>.jpg</code>, <code>.webp</code>, <code>.bmp</code>, and <code>.gif</code>.</p>

                    <h3 style="margin-top: 2em;">Icon Naming Conventions</h3>
                    <p>Icons use a strict prefix-based naming scheme: <code>prefix.name.png</code>. The prefix indicates the category; the name is matched against media properties. Files that don’t follow this convention are ignored.</p>

                    <h4 style="margin-top: 2em;">Language &amp; Subtitle Icons</h4>
                    <p>
                        <strong>Audio Language (prefix: lang):</strong> <code>lang.{name}.png</code><br />
                        <em>{name}</em> must be the full display language name (exactly as Emby shows it), lowercased.<br />
                        <em>Example:</em> <code>lang.english.png</code>, <code>lang.french.png</code>
                    </p>

                    <p>
                        <strong>Subtitle Language (prefix: sub):</strong> <code>sub.{name}.png</code><br />
                        <em>{name}</em> must be the full display language name, lowercased.<br />
                        <em>Example:</em> <code>sub.english.png</code>, <code>sub.japanese.png</code>
                    </p>

                    <h4 style="margin-top: 2em;">Dynamic Detection</h4>
                    <p>Most categories are detected directly from media stream metadata (no filename hacks required). You can create icons for any codec/layout Emby recognizes.</p>

                    <p>
                        <strong>Parental Rating (prefix: pr):</strong> <code>pr.{rating}.png</code><br />
                        <em>{rating}</em> should match the official rating reported by Emby (e.g., <code>pg-13</code>, <code>tv-ma</code>) in lowercase.<br />
                        <em>Example:</em> <code>pr.pg-13.png</code>, <code>pr.tv-ma.png</code>
                    </p>

                    <p>
                        <strong>Audio Codec (prefix: ac):</strong> <code>ac.{codec_name}.png</code><br />
                        <em>{codec_name}</em> should match the codec reported by Emby (e.g., <code>eac3</code>, <code>dts-hdma</code>).<br />
                        <em>Example:</em> <code>ac.eac3.png</code>, <code>ac.dts-hdma.png</code>
                    </p>

                    <p>
                        <strong>Video Codec (prefix: vc):</strong> <code>vc.{codec_name}.png</code><br />
                        <em>{codec_name}</em> should match the codec reported by Emby (e.g., <code>hevc</code>, <code>av1</code>).<br />
                        <em>Example:</em> <code>vc.hevc.png</code>, <code>vc.av1.png</code>
                    </p>

                    <p>
                        <strong>Audio Channels (prefix: ch):</strong> <code>ch.{layout_name}.png</code><br />
                        <em>{layout_name}</em> should match the audio layout reported by Emby (e.g., <code>5.1</code>, <code>7.1</code>, <code>stereo</code>).<br />
                        <em>Example:</em> <code>ch.5.1.png</code>, <code>ch.7.1.png</code>, <code>ch.stereo.png</code>
                    </p>

                    <p>
                        <strong>Resolution (prefix: res):</strong> <code>res.{resolution_name}.png</code><br />
                        Resolution is derived from the video stream (e.g., <code>4k</code>, <code>1080p</code>, <code>1080i</code>) and matched against available icon keys.<br />
                        <em>Example:</em> <code>res.4k.png</code>, <code>res.1080p.png</code>, <code>res.1080i.png</code>
                    </p>

                    <p>
                        <strong>Aspect Ratio (prefix: ar):</strong> <code>ar.{ratio}.png</code><br />
                        Uses video stream aspect ratio with the colon replaced by <code>x</code> (e.g., <code>16x9</code>, <code>4x3</code>).<br />
                        <em>Example:</em> <code>ar.16x9.png</code>, <code>ar.4x3.png</code>
                    </p>

                    <p>
                        <strong>Video Format (prefix: hdr):</strong> <code>hdr.{format_name}.png</code><br />
                        Detects HDR/Dolby Vision from stream metadata; supported names include <code>hdr</code> and <code>dv</code>. You can also add others you provide icons for.<br />
                        <em>Example:</em> <code>hdr.dv.png</code>, <code>hdr.hdr.png</code>
                    </p>

                    <h4 style="margin-top: 2em;">Other Categories</h4>

                    <p>
                        <strong>Custom Tags (prefix: tag):</strong> <code>tag.{name}.png</code><br />
                        Matches against media item tags (case-insensitive). Tags are normalized: lowercased, whitespace collapsed to hyphens, and leading/trailing hyphens removed.<br />
                        <em>Examples:</em> <code>Behind the Scenes</code> → <code>tag.behind-the-scenes.png</code>, <code>3D</code> → <code>tag.3d.png</code>
                    </p>

                    <p>
                        <strong>Community Rating (prefix: rating):</strong> <code>rating.{name}.png</code><br />
                        Displayed next to the community score.<br />
                        <em>Example:</em> <code>rating.imdb.png</code>
                    </p>

                    <h3 style="margin-top: 2em;">Notes &amp; Tips</h3>
                    <ul>
                        <li>Language and subtitle icons use the <em>display language</em> shown by Emby (not ISO codes).</li>
                        <li>For collections and series, language icons require all children to share the same display language unless Lite Mode is used.</li>
                        <li>If icons don’t appear as expected, use the <strong>Troubleshooter</strong> tab to find inconsistencies.</li>
                    </ul>

                    <div style="margin-top: 3em; padding: 1em; background-color: rgba(255, 235, 59, 0.1); border-left: 4px solid #ffeb3b; border-radius: 4px;">
                        <div style="display: flex; align-items: center; gap: 1em;">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24" width="24" fill="#ffeb3b" style="flex-shrink: 0;">
                                <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"></path>
                            </svg>
                            <div>
                                <p style="margin: 0 0 0.5em 0; font-weight: 500;">Thank you to all supporters and everyone who helped test this, especially Neminem from the Emby forum.</p>
                                <p style="margin: 0;">If you like this project and want to support it you can <a href="https://buymeacoffee.com/yockser" target="_blank" rel="noopener noreferrer">donate a coffee</a>. Add your name and we’ll list it here!</p>
                                <p style="margin: 0 0 0.5em 0; font-weight: 500;">Thank you for the donations to:</p>
                                <p style="margin: 0 0 0.5em 0; font-weight: 500;">Alexander Hürter.<br />John Spiegel.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <template id="addProfileDialogTemplate">
        <div class="dialogHeader">
            <button is="emby-button" type="button" class="paper-icon-button-light btnCancel" tabindex="-1"><i class="md-icon">arrow_back</i></button>
            <h3 class="dialogTitle">Add New Profile</h3>
        </div>
        <div class="dialogContent">
            <form class="dialogContentInner" style="padding-top: 2em;">
                <div class="inputContainer">
                    <input is="emby-input" id="txtNewProfileName" type="text" label="Profile Name:" required="required" />
                </div>
                <div class="dialogButtons">
                    <button is="emby-button" type="submit" class="raised button-submit block"><span>Save</span></button>
                </div>
            </form>
        </div>
    </template>

    <template id="renameProfileDialogTemplate">
        <div class="dialogHeader">
            <button is="emby-button" type="button" class="paper-icon-button-light btnCancel" tabindex="-1"><i class="md-icon">arrow_back</i></button>
            <h3 class="dialogTitle">Rename Profile</h3>
        </div>
        <div class="dialogContent">
            <form class="dialogContentInner" style="padding-top: 2em;">
                <div class="inputContainer">
                    <input is="emby-input" id="txtRenameProfile" type="text" label="Profile Name:" required="required" />
                </div>
                <div class="dialogButtons">
                    <button is="emby-button" type="submit" class="raised button-submit block"><span>Save</span></button>
                </div>
            </form>
        </div>
    </template>

</div>